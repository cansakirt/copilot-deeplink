<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Copilot App Deeplink - Final Attempts</title>
        <style>
            body {
                font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans",
                    "Helvetica Neue", sans-serif;
                margin: 20px;
                line-height: 1.6;
            }
            .container {
                max-width: 700px;
                margin: 0 auto;
            }
            h1,
            h2,
            h3 {
                color: #333;
            }
            h2 {
                margin-top: 30px;
                border-bottom: 1px solid #eee;
                padding-bottom: 8px;
            }
            h3 {
                margin-top: 20px;
                color: #444;
            }
            .info,
            .important-note,
            .final-thoughts {
                background-color: #eef7ff;
                border-left: 4px solid #007bff;
                padding: 15px;
                margin-bottom: 20px;
                border-radius: 4px;
            }
            .success-info {
                background-color: #d4edda;
                border-left-color: #28a745;
                color: #155724;
            }
            .important-note {
                background-color: #fff3cd;
                border-left-color: #ffeeba;
            }
            .final-thoughts {
                background-color: #f8d7da;
                border-left-color: #dc3545;
                color: #721c24;
            }
            label {
                font-weight: 600;
                display: block;
                margin-bottom: 8px;
                color: #555;
            }
            input[type="text"] {
                width: calc(100% - 24px);
                padding: 10px;
                margin-bottom: 25px;
                border: 1px solid #ccc;
                border-radius: 4px;
                font-size: 16px;
            }
            .test-case {
                margin-bottom: 20px;
                padding: 15px;
                border: 1px solid #e0e0e0;
                border-radius: 5px;
                background-color: #f9f9f9;
            }
            .test-case p.description {
                font-size: 0.95em;
                color: #555;
                margin-bottom: 10px;
            }
            .test-case code {
                background-color: #f0f0f0;
                padding: 2px 5px;
                border-radius: 3px;
                font-size: 0.9em;
                word-break: break-all;
            }
            .test-case .actions a,
            .test-case .actions button {
                margin-right: 10px;
                margin-bottom: 5px; /* For wrapping */
                padding: 9px 15px;
                background-color: #007bff;
                color: white;
                border: none;
                border-radius: 4px;
                text-decoration: none;
                cursor: pointer;
                display: inline-block;
                font-size: 14px;
                transition: background-color 0.2s ease;
            }
            .test-case .actions a:hover,
            .test-case .actions button:hover {
                background-color: #0056b3;
            }
            .primary-target {
                border-left: 4px solid #28a745;
            }
            .long-shot {
                border-left: 4px solid #fd7e14;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>Copilot App Deeplink - Final Attempts</h1>

            <div class="info success-info">
                <p>
                    <strong>Recap:</strong> <code>copilotn://conversation</code> successfully creates a new chat in the native app. We are
                    now making final attempts to prefill the message using this path and also re-testing Universal Links.
                </p>
            </div>

            <label for="prefillText">Text to Prefill:</label>
            <input type="text" id="prefillText" value="Final prefill attempt!" />

            <div id="test-sections">
                <!-- Test cases will be dynamically inserted here -->
            </div>
        </div>

        <script>
            const prefillInput = document.getElementById("prefillText");
            const sectionsContainer = document.getElementById("test-sections");

            function getCurrentEncodedText() {
                return encodeURIComponent(document.getElementById("prefillText").value);
            }

            function generateTestCases() {
                sectionsContainer.innerHTML = ""; // Clear previous
                const encodedText = getCurrentEncodedText(); // Get current text for initial URL patterns

                const sections = {
                    customSchemeFocus: {
                        title: "Focused Custom Scheme: `copilotn://conversation` + Parameters",
                        description: `Since <code>copilotn://conversation</code> opens a new chat, these are the most plausible parameter variations for prefilling with that specific path.`,
                        tests: [
                            {
                                id: "conv_prompt",
                                name: `<code>copilotn://conversation?prompt=</code>`,
                                urlPatternBase: `copilotn://conversation?prompt=`,
                                notes: "<strong>Highest probability for this path.</strong>",
                                isPrimaryTarget: true,
                            },
                            {
                                id: "conv_q",
                                name: `<code>copilotn://conversation?q=</code>`,
                                urlPatternBase: `copilotn://conversation?q=`,
                                notes: "Alternative 'query' parameter.",
                            },
                            {
                                id: "conv_text",
                                name: `<code>copilotn://conversation?text=</code>`,
                                urlPatternBase: `copilotn://conversation?text=`,
                                notes: "Generic 'text' parameter.",
                            },
                            {
                                id: "conv_message",
                                name: `<code>copilotn://conversation?message=</code>`,
                                urlPatternBase: `copilotn://conversation?message=`,
                                notes: "Generic 'message' parameter.",
                            },
                            {
                                id: "conv_initialText",
                                name: `<code>copilotn://conversation?initialText=</code>`,
                                urlPatternBase: `copilotn://conversation?initialText=`,
                                notes: "Descriptive 'initialText'.",
                            },
                        ],
                    },
                    universalLinksRecheck: {
                        title: "Re-check HTTPS / Universal Links",
                        description:
                            "It's crucial to confirm if these HTTPS links open the NATIVE APP and prefill. If they do, this is the preferred iOS method.",
                        tests: [
                            {
                                id: "https_copilotRootPrompt",
                                name: "<code>https://copilot.microsoft.com/?prompt=</code>",
                                urlPatternBase: `https://copilot.microsoft.com/?prompt=`,
                                isPrimaryTarget: true,
                            },
                            {
                                id: "https_copilotChatsNewPrompt",
                                name: "<code>https://copilot.microsoft.com/chats/new?prompt=</code>",
                                urlPatternBase: `https://copilot.microsoft.com/chats/new?prompt=`,
                            },
                            {
                                id: "https_bingChatPrompt",
                                name: "<code>https://www.bing.com/chat?prompt=</code>",
                                urlPatternBase: `https://www.bing.com/chat?prompt=`,
                            },
                        ],
                    },
                    longShots: {
                        title: "Long Shot - Action Payload (Highly Speculative)",
                        description:
                            "This tests if the app might accept a URL-encoded JSON payload, similar to its internal action structure. This is very unlikely for a simple custom URL scheme.",
                        tests: [
                            {
                                id: "conv_action_payload",
                                name: `<code>copilotn://conversation?action={payload}</code>`,
                                isPayloadTest: true, // Special handling
                                notes: "Extremely speculative.",
                                isLongShot: true,
                            },
                            {
                                id: "root_action_payload",
                                name: `<code>copilotn://?action={payload}</code>`,
                                isPayloadTest: true, // Special handling
                                notes: "Action payload at root. Also very speculative.",
                                isLongShot: true,
                            },
                        ],
                    },
                };

                for (const sectionKey in sections) {
                    const sectionData = sections[sectionKey];
                    const sectionEl = document.createElement("section");

                    const sectionTitleEl = document.createElement("h2");
                    sectionTitleEl.textContent = sectionData.title;
                    sectionEl.appendChild(sectionTitleEl);

                    const sectionDescEl = document.createElement("p");
                    sectionDescEl.innerHTML = sectionData.description;
                    sectionEl.appendChild(sectionDescEl);

                    sectionData.tests.forEach((test) => {
                        const div = document.createElement("div");
                        div.className = "test-case";
                        if (test.isPrimaryTarget) div.classList.add("primary-target");
                        if (test.isLongShot) div.classList.add("long-shot");

                        const nameP = document.createElement("p");
                        nameP.innerHTML = `<strong>Test:</strong> ${test.name}`;
                        div.appendChild(nameP);

                        if (test.notes) {
                            const notesP = document.createElement("p");
                            notesP.className = "description";
                            notesP.innerHTML = test.notes;
                            div.appendChild(notesP);
                        }

                        let currentUrlPattern;
                        if (test.isPayloadTest) {
                            const actionObject = { type: "prefillComposer", prompt: "Placeholder for payload test" }; // Actual text will be subbed on click
                            const examplePayload = encodeURIComponent(JSON.stringify(actionObject));
                            if (test.id.startsWith("conv_")) {
                                currentUrlPattern = `copilotn://conversation?action=${examplePayload}`;
                            } else {
                                currentUrlPattern = `copilotn://?action=${examplePayload}`;
                            }
                            const urlP = document.createElement("p");
                            urlP.innerHTML = `<em>Example URL structure:</em> <code>${currentUrlPattern.replace(
                                encodeURIComponent("Placeholder for payload test"),
                                "{ENCODED_TEXT_HERE}"
                            )}</code>`;
                            div.appendChild(urlP);
                        } else {
                            currentUrlPattern = test.urlPatternBase + encodedText;
                            const urlP = document.createElement("p");
                            urlP.innerHTML = `<em>Generated URL:</em> <code>${currentUrlPattern}</code>`;
                            div.appendChild(urlP);
                        }

                        const actionsDiv = document.createElement("div");
                        actionsDiv.className = "actions";

                        const button = document.createElement("button");
                        button.textContent = "Test via JS Redirect";
                        button.onclick = () => {
                            let finalUrl;
                            if (test.isPayloadTest) {
                                const actionObject = { type: "prefillComposer", prompt: document.getElementById("prefillText").value };
                                const livePayload = encodeURIComponent(JSON.stringify(actionObject));
                                if (test.id.startsWith("conv_")) {
                                    finalUrl = `copilotn://conversation?action=${livePayload}`;
                                } else {
                                    finalUrl = `copilotn://?action=${livePayload}`;
                                }
                            } else {
                                finalUrl = test.urlPatternBase + getCurrentEncodedText();
                            }
                            console.log("Attempting JS redirect to:", finalUrl);
                            window.location.href = finalUrl;
                        };
                        actionsDiv.appendChild(button);

                        const link = document.createElement("a");
                        link.textContent = "Test via <a> Link";
                        link.href = "#";
                        link.onclick = (e) => {
                            e.preventDefault();
                            let finalUrl;
                            if (test.isPayloadTest) {
                                const actionObject = { type: "prefillComposer", prompt: document.getElementById("prefillText").value };
                                const livePayload = encodeURIComponent(JSON.stringify(actionObject));
                                if (test.id.startsWith("conv_")) {
                                    finalUrl = `copilotn://conversation?action=${livePayload}`;
                                } else {
                                    finalUrl = `copilotn://?action=${livePayload}`;
                                }
                            } else {
                                finalUrl = test.urlPatternBase + getCurrentEncodedText();
                            }
                            console.log("Attempting <a> link to:", finalUrl);
                            window.location.href = finalUrl;
                            return false;
                        };
                        actionsDiv.appendChild(link);
                        div.appendChild(actionsDiv);
                        sectionEl.appendChild(div);
                    });
                    sectionsContainer.appendChild(sectionEl);
                }

                const finalThoughtsEl = document.createElement("div");
                finalThoughtsEl.className = "final-thoughts";
                finalThoughtsEl.innerHTML = `<h3>Final Thoughts</h3>
                                        <p>If none of these tests result in the native app opening AND prefilling the composer:</p>
                                        <ul>
                                            <li><strong>Universal Links (HTTPS):</strong> The app may not be fully configured to handle these specific URLs/parameters for native prefill, or they might only prefill the web view.</li>
                                            <li><strong>Custom Scheme (<code>copilotn://conversation</code>):</strong> While it opens a new chat, it likely isn't designed to parse additional query parameters for prefilling from an external call. The internal prefill mechanisms (like the <code>widgets.json</code>) are not directly exposed via this simple scheme.</li>
                                        </ul>
                                        <p>In such a case, the app developers would need to explicitly add support for this exact deeplinking prefill feature via either Universal Links or by enhancing their custom URL scheme handler.</p>`;
                sectionsContainer.appendChild(finalThoughtsEl);
            }

            prefillInput.addEventListener("input", generateTestCases); // Regenerate if text changes
            window.addEventListener("load", generateTestCases);
        </script>
    </body>
</html>
